oc.diffusion.subscriberClientNew=function(){function e(e,t,a){$.log("Subscribing to = "+n),e.subscribe(a).asType(t).on({value:function(e,t,a,o){a=a.get(),oc.debugOn&&($.log("Topic: "+e),$.log(a)),m(e,a)},subscription:function(){}});var s=setTimeout(function(){o||!e||e.isClosed()||e.close()},1e4);i[a]={session:e,diffTimeout:s}}function t(t){if($.log("Connection Status = "+t.isConnected()),t.isConnected()){var a=diffusion.datatypes.json();oc.mobileIsMatchView=$activePanel(".beta-match-odds-list").length>0,n.forEach(function(o,i){setTimeout(function(){e(t,a,o)},150*i)})}}oc.diffusion.betslipData=[];var a,o=!1,i={},s=$activePanel("#wrapper.fixtures-racing").length>0,n=[],d=6e5,r=6e4,c=25,f=0,l=0,u=function(e){b(n),n=e.topic;var a="443";$.log("oc diffusion server : "+oc.diffusion.server),n.length>0&&diffusion.connect({host:oc.diffusion.server,port:a,secure:!0,reconnect:{timeout:d,strategy:v}}).then(t,function(e){$.log("failed to connect"+e)})},b=function(e){e.forEach(function(e){if(""!==e){var t=i[e].session,a=i[e].diffTimeout;oc.diffusion.betslipData=[],$.log("Disconnecting previous Diffusion Topic: "+e),t&&!t.isClosed()&&(t.close(),a&&clearTimeout(a))}})};oc.mobileIsMatchView=!1;var v=function(e,t){if($.log("****Lost Connection to Diffusion Server.****"),f>c)$.log("Attempt number :"+f+"."),t();else{$.log("****Attempting to reconnect with Diffusion Server****");var a=Math.min(100*Math.pow(2,f++),r);setTimeout(e,a)}},m=function(e,t){o=!0,t.hasOwnProperty("bestOddsPrice")?p(t):g(e,t)},p=function(e){var t=$activePanel('.basket-add[data-bid="'+e.ocBetId+'"]');if(t.length>0&&!t.hasClass("non-runner")){var a=t.find(".odds, .data-o"),o=t.find(".fixtures-bet-odds");0===a.length&&0===o.length&&t.hasClass("odds")&&(a=t);var i;if(e.bestOddsPrice>0)i=h(e.bestOddsFractional,e.bestOddsPrice);else if(0===e.bestOddsPrice&&e.bestOddsExchange)switch(oc.oddsType){case"traditional":i=e.bestOddsExchangeFractional;break;case"decimal":i=e.bestOddsExchange+"";break;case"us":i=E(e.bestOddsExchange)+""}else 0===e.bestOddsPrice&&(i="SP");var n=Number(t.attr("data-best-dig"));if($.log("DIFFUSION NON GRIDS | Bet Name: "+t.find(".fixtures-bet-name").text()+" / Bet ID: "+e.ocBetId+" / Current Odds: "+n+" / New Odds: "+e.bestOddsPrice+" / Will Update? "+(e.bestOddsPrice!==n)),e.bestOddsPrice!==n){var d=e.bestOddsPrice>n?"drifter":"steamer",r=a.hasClass("drifter")?"drifter":a.hasClass("steamer")?"steamer":"",c=a[0].innerText;requestAnimationFrame(function(){a.addClass(d),a.addClass("diff-flash")});var f=a.parents(".subevent-content").find(".recent-odds-history");if(f.length){var l=f.find("span"),u='<span class="beta-caption2 '+r+'">'+c+"</span>";l.length>=3&&$(l[0]).remove(),f.append(u)}setTimeout(function(){o.length?requestAnimationFrame(function(){o.text(i)}):s||requestAnimationFrame(function(){a.text(i)})},1e3),setTimeout(function(){requestAnimationFrame(function(){a.removeClass("diff-flash")})},2e3)}t.attr("data-best-dig",e.bestOddsPrice)}},h=function(e,t){var a="";switch(oc.oddsType){case"traditional":a=e;break;case"decimal":a=t+"";break;case"us":a=E(t)+"";break;case"winnings":a=t*oc.oddsDefaultStake,a=Math.round(100*t)/100,a=t.toFixed(2)}return a},g=function(e,t){var a=$activePanel('.diff-row[data-bid="'+t.ocBetId+'"]');if(1===t.nonRunner)return void y(a);var o=e,i=o.split("/"),s=i[1].split("_")[0],n=i[3].split("_")[1];if("market"===s){var d=P(n),r=common.getBetButtonObject(t.ocBetId,n);if("undefined"==typeof r[0]||null===r[0])return;if(null!==t.odds&&void 0!==t.odds){var c=common.getOddsCellFromButton(r);0===a.length&&(a=r);var f=t.odds,l=t.oddsDig;!oc.applyExchangeCommission&&d&&(f=t.oddsNoCommission,l=t.oddsDigNoCommission);var u=h(f,l);if("MOBILE"===oc.platform&&oc.mobileIsMatchView){var b=c.parents(".diff-row");if(t.failed||""===f||"-"===f||"0"===f){for(var v=b.find(".bc").not('[data-bid="'+t.ocBetId+'"]'),m=!0,p=0,g=v.length;p<g;p++){var C=v[p];""!==C.innerText.trim()&&(m=!1)}m&&b.addClass("hide")}else b.removeClass("hide")}if(""===f||"-"===f||"0"===f)return c.text(""),r.removeClass("b o oi oo np bs").addClass("o bc"),void("DESKTOP"===oc.platform&&c.remove());if(a.hasClass("evTabRow")&&a.hasClass("nonRunner"))return"SP"===f?c.text(f):c.text(u),void r.removeClass("b o oi oo np bs").addClass("o bc");k(t,r),R(t,r,c,f,l,u);var O=S(t,a);return oc.diffusion.betslipData[t.ocBetId]||(oc.diffusion.betslipData[t.ocBetId]=[]),oc.diffusion.betslipData[t.ocBetId][n]={bestOdds:O.bestOdds,bestOddsBookies:O.bestOddsBookies,betId:t.ocBetId,betSelectionId:t.selectionId,bookieCode:n,eachWayDenominator:t.eachWayDenominator,eachWayPlaces:t.eachWayPlaces,handicap:t.handicapDig,oddsDecimal:t.oddsDig,oddsFractional:t.odds,suspended:t.failed},void(t.priceType&&null!==t.priceType&&(oc.diffusion.betslipData[t.ocBetId][n].priceType=t.priceType))}}else if("fixture"===s)return void diffusionScoreCard.update(i,t)},C=function(e){return!(!e.hasClass("evTabRow")||!e.hasClass("nonRunner"))},O=function(){return oc.eachWayMarketCategories.indexOf(oc.marketCategoryGroupName)>-1},T=["BF","MA","BD","MK"],x=["RK"],D=["TD"],P=function(e){return T.indexOf(e)>-1},B=function(e){var t=O()?T.concat(D,x):T;return t.indexOf(e)>-1},I={reset:!1,bet:{}},w=function(e,t){if(I.reset){var a=t.ocBetId+"_"+t.bookieCode;return void 0!==I[a]||(I[a]=e.attr("data-odig")),I[a]}return""===e.attr("data-fodds")&&e.attr("data-fodds",t.oddsDig),Number(e.attr("data-fodds"))},k=function(e,t){var a="o",o=P(e.bookieCode),i=w(t,e),s=e.oddsDig;o&&(s=e.oddsDigNoCommission),1===e.failed?t.hasClass("np")||t.removeClass("o oi oo np bs").addClass("o np"):(i>0&&s>0&&(i>s?a="oi":i<s?a="oo":i===s&&(a="o")),1===t.length&&t.removeClass("o oi oo np").addClass(a+" bc bs"))},y=function(e){if(!e.hasClass("evTabRow")&&!e.hasClass("nonRunner")){var t=e.find(".selTxt"),a=t.attr("data-name");e.removeClass("evTabRow").addClass("evTabRow nonRunner"),e.find(".bs").removeClass("bs"),t.html(t.html().replace(a,a+" (N/R)")),e.attr("data-best-dig","9999.0"),"DESKTOP"===oc.platform&&N(!0);var o=$activePanel(".evTabRow.nonRunner").length,i=$activePanel(".diff-row").length;$activePanel(".footerNonRunText").text("Non-Runners: "+o+" / "+i)}},S=function(e,t){if("undefined"==typeof t[0]||null===t[0])return void $.log("processBestOddsBolding Warning: Wrong MarketId >>>"+e.marketId+"<<< Has been sent");var o="",i=0,s=0;if(!oc.isHandicapGroup){var n,d=!1,r=[],c=[];"DESKTOP"===oc.platform?n=t.find(".bc[data-bk]"):t.hasClass("header-cell")?n=$activePanel('.grid-cell[data-bid="'+e.ocBetId+'"]'):(d=!0,n=t.find("[data-bk][data-odig]")),n.each(function(){var e=$(this).attr("data-bk"),t=B(e),a=Number($(this).attr("data-odig"));a>0&&(t||(a>i&&(r=[],i=a),a===i&&r.push(e)),t&&(a>s&&(c=[],s=a),a===s&&c.push(e)))});var f=c.concat(r);f.sort(),o=f.join(",");var l=t.attr("data-best-bks");l!==o&&(t.attr("data-best-bks",o),n.each(function(){var e=$(this).attr("data-bk"),t=B(e),a="",o="";if($(this).parent().hasClass("beta-best-odds-cell")||(d?(a="bew b",o=O()?"bwo b":"bew b"):(a="b",o=O()?"win-only":"b")),!t){var n=r.indexOf(e)!==-1;$(this).attr("data-best-ew",n);var f=n?"addClass":"removeClass";$(this)[f](a)}if(t){var n=n=O()?c.indexOf(e)!==-1:c.indexOf(e)!==-1&&s>=i,f=n?"addClass":"removeClass";$(this)[f](o)}}));var u=Number(t.attr("data-best-dig")),b=0===i?0===s?9999:s:i,v=C(t),m=!1;b===u||v||(m=!0,t.attr("data-best-dig",b)),"0"===oc.aOSHCstate&&(1!==e.failed||v||N(m),m&&(clearTimeout(a),a=setTimeout(function(){N(m)},1e3)))}return{bestOdds:0===i?s:i,bestOddsBookies:o}},N=function(e){!oc.isHandicapGroup&&e&&(l++,ts_resortTab(oc.aOSHCstate))},R=function(e,t,a,o,i,s){var n=t.parents("[data-bid]");0===n.length&&(n=t);var d=C(n);if(1===e.failed&&!d)return a.text(""),t.attr("data-odig","0"),void("DESKTOP"===oc.platform&&a.remove());if("SP"===o)return a.text(o),t.attr("data-odig",i),void t.removeClass("b o oi oo np").addClass("o bc bs");var r=a[0].innerHTML;if("MOBILE"!==oc.platform&&"TABLET"!==oc.platform||"traditional"!==oc.oddsType?s.endsWith("/1")&&(s=s.replace("/1","")):s.indexOf("/")===-1&&(s+="/1"),s.length>5){var c=s.indexOf("/");c!=-1&&(s=s.substring(0,c)+"/ "+s.substring(c+1))}if(s!==r){if(d)return void a.text(s);oc.isHandicapGroup&&(s=e.handicap+"<br>"+s),1===t.find("p").length?a.addClass("animating diff-flash"):t.addClass("animating diff-flash"),t.attr("data-odig",i),t.attr("data-o",o),setTimeout(function(){oc.isHandicapGroup?a[0].innerHTML=s:a.text(s),1===t.find("p").length?a.removeClass("diff-flash"):t.removeClass("diff-flash"),setTimeout(function(){1===t.find("p").length?a.removeClass("animating"):t.removeClass("animating")},1e3)},1e3)}},E=function(e){return e-=1,e<1?e=1/e*-100:e*=100,parseInt(e)};return{init:u}}();